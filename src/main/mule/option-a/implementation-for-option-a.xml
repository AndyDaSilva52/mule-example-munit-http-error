<?xml version="1.0" encoding="UTF-8"?>

<mule
  xmlns:http="http://www.mulesoft.org/schema/mule/http"
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
    http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
    http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

  <http:request-config
    name="HTTP_Request_configuration_External"
    doc:name="HTTP Request configuration"
    basePath="/api" />
  <http:request-config
    name="HTTP_Request_configuration_System"
    doc:name="HTTP Request configuration"
    basePath="/api" />
  <http:request-config
    name="HTTP_Request_configuration_Process"
    doc:name="HTTP Request configuration"
    basePath="/api" />

  <sub-flow name="implementation-for-option-a.subflow">
    <logger
      level="INFO"
      doc:name="INFO BEFORE"
      message="#[output application/json --- { tracepoint: 'BEFORE', message   : message }]" />
    <try doc:name="Try">
      <http:request
        method="GET"
        doc:name="HTTP Req External GET /health"
        config-ref="HTTP_Request_configuration_External"
        path="/health"
        sendBodyMode="ALWAYS" />
      <error-handler>
        <on-error-continue
          enableNotifications="true"
          logException="true"
          doc:name="On Error Continue"
          when="#[ ( error.errorMessage.attributes.statusCode == 400 ) and ( error.errorMessage.payload.message contains 'Account already exists!' ) ]">
          <logger
            level="ERROR"
            message="#[output application/json --- { tracepoint: 'EXCEPTION', }]"
            doc:name="ERROR EXCEPTION" />
        </on-error-continue>
      </error-handler>
    </try>
    <try doc:name="Try">
      <http:request
        method="GET"
        doc:name="HTTP Req System GET /health validResponseCode=200..204"
        config-ref="HTTP_Request_configuration_System"
        path="/health"
        sendBodyMode="ALWAYS">
        <http:response-validator>
          <http:success-status-code-validator
            values="200..204" />
        </http:response-validator>
      </http:request>
      <error-handler>
        <on-error-continue
          enableNotifications="true"
          logException="true"
          doc:name="On Error Continue"
          when="#[ (error.errorMessage.attributes.statusCode == 503) ]">
          <logger
            doc:name="ERROR EXCEPTION"
            message="#[output application/json --- { tracepoint: 'EXCEPTION', }]"
            level="INFO" />
        </on-error-continue>
      </error-handler>
    </try>
    <http:request
      method="GET"
      doc:name="HTTP Req Process GET /health"
      path="/health"
      config-ref="HTTP_Request_configuration_Process"
      sendBodyMode="ALWAYS">
    </http:request>
  </sub-flow>


</mule>