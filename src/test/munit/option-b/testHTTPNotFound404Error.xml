<?xml version="1.0" encoding="UTF-8"?>

<mule
  xmlns:http="http://www.mulesoft.org/schema/mule/http"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
  xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
  xmlns="http://www.mulesoft.org/schema/mule/core"
  xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
  xsi:schemaLocation="
		http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
		http://www.mulesoft.org/schema/mule/munit-tools  http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">
  <munit:config name="testHTTPNotFoundError.xml" />

  <http:request-config
    name="HTTP_Request_configuration"
    doc:name="HTTP Request configuration">
    <http:request-connection
      host="localhost"
      port="8081" />
  </http:request-config>

  <!-- Test Case 1: Expecting a Mule Error -->
  <munit:test
    name="testHTTPNotFound404Error-MuleError"
    description="Test"
    expectedErrorType="HTTP:NOT_FOUND">
    <munit:enable-flow-sources>
      <munit:enable-flow-source value="HTTPEndpoint" />
    </munit:enable-flow-sources>
    <munit:execution>
      <!-- This request to a non-existent path will fail, triggering the expected error. -->
      <http:request
        method="GET"
        doc:name="Request"
        config-ref="HTTP_Request_configuration"
        path="/NotExist" />
    </munit:execution>
  </munit:test>

  <!-- Test Case 2: Validating the Status Code Directly -->
  <munit:test name="testHTTPNotFound404Error-HTTPStatusCode">
    <munit:enable-flow-sources>
      <munit:enable-flow-source value="HTTPEndpoint" />
    </munit:enable-flow-sources>
    <munit:execution>
      <http:request
        method="GET"
        doc:name="Request"
        config-ref="HTTP_Request_configuration"
        path="/NotExist">
        <!-- This response validator tells the requester not to throw an error for a 404 response. -->
        <http:response-validator>
          <http:success-status-code-validator
            values="404" />
        </http:response-validator>
      </http:request>
    </munit:execution>
    <munit:validation>
      <!-- Since no error was thrown, we can now assert the status code from the response attributes. -->
      <munit-tools:assert-equals
        doc:name="Assert equals"
        actual="#[attributes.statusCode]"
        expected="#[404]"
        message="Target HTTP Endpoint doesn't return 404 status code as expected" />
    </munit:validation>
  </munit:test>

  <munit:test name="testHTTPNotFound404ErrorTest-HTTPMessageBody">
    <munit:enable-flow-sources>
      <munit:enable-flow-source value="HTTPEndpoint" />
    </munit:enable-flow-sources>
    <munit:behavior>
      <munit-tools:mock-when
        doc:name="Mock when"
        processor="http:request">
        <munit-tools:with-attributes>
          <munit-tools:with-attribute
            whereValue="GET"
            attributeName="method" />
          <munit-tools:with-attribute
            whereValue="Request"
            attributeName="doc:name" />
          <munit-tools:with-attribute
            whereValue="HTTP_Request_configuration1"
            attributeName="config-ref" />
          <munit-tools:with-attribute
            whereValue="/NotExist"
            attributeName="path" />
        </munit-tools:with-attributes>
        <munit-tools:then-return>
          <munit-tools:error typeId="HTTP:NOT_FOUND" />
        </munit-tools:then-return>
      </munit-tools:mock-when>
    </munit:behavior>
    <munit:execution>
      <http:request
        method="GET"
        doc:name="Request"
        config-ref="HTTP_Request_configuration"
        path="/">
        <http:response-validator>
          <http:success-status-code-validator
            values="404" />
        </http:response-validator>
      </http:request>
    </munit:execution>
    <munit:validation>
      <munit-tools:assert-equals
        doc:name="Assert equals"
        actual="#[payload]"
        expected='#["Upstream service resource not available"]' />
    </munit:validation>
  </munit:test>

</mule>
